# hw09
* В крон забита строка запускающая скрипт от имени рута с кодами в 15 минут каждого часа *
```
[root@localhost ~]# crontab -e
15 * * * * /home/vagrant/hw09/ohw09script.sh 10 5
```
* Приложены файлы mail - письмо, которое получается в результате работы скрипта, пример обрабатываемого лога и сам скрипт *
* Сам скрипт, объявляю скрипт запускаемым в баше, сделал исполяемым файл, 1=X and 2=Y вводимые переменные #echo $N использовал на период отладки*
```
#!/bin/bash
#echo $1
#echo $2
```
* Про flock прочитал, но решил сделать лок файл через функцию, чтобы задейстовать трапы, ну и не до конца понял (времени мало было) при каких обстоятельствах такой вариант будет ущербным *
```
function MyFirstFunction {
        LOCKFILE=/var/lock/ohw09.lock
if [[ -f $LOCKFILE ]]; then
  echo "script is already locked!" >&2
  exit 1
fi
touch $LOCKFILE
}
MyFirstFunction
```
* Для сокращения написания использовал переменные, создаю временный файл для заполнения тела письма *
```
MailFileText=/var/tmp/ohw09.txt
MyLogFile=/home/vagrant/hw09/access-4560-644067.log
touch $MailFileText
```
* Выдёргиваю дату начала скрипта, подразумеваю, что скрипт перезаписывается и дата меняется со временем *
```
StartDate=`cat $MyLogFile | cut -f 4 -d ' ' | head -n 1 | sed 's/^\[//'`
```
* Вывожу временной промежуток, чуток не доработал с форматом времени ((( *
```
{ echo "временной промежуток с $StartDate по $(date)"
```
* Список IP адресов из X заданных строк ... , долго игрался с вычленением IP и доменных имён, пока не нашёл, что логах всё структурировано и находится на своих местах в колонках 1 - IP, 2 - дата и т.д.*
```
echo "список IP адресов из Х (10) заданных строк с количестом запросов от них в порядке убывания"
echo "Ip                  value"
cat $MyLogFile | cut -f 1 -d' ' | sort | uniq -c | sort -r -n | head -n "$1" | sed -r 's/(.*) (.*)/\2 \1/'
echo " "
```
* Cписок запрашиваемых адресов из Y (5) строк + количество запросов с момента последнего запуска скрипта с наибольшим количеством запросов*
```
echo "список запрашиваемых адресов из Y строк + количество запросов с момента последнего запуска скрипта с наибольшим количеством запросов"
echo "name                value"
cat $MyLogFile | cut -f 11 -d ' ' | grep -v "-" | awk -F[/:] '{print $4}' | sed 's/"//' | sort | uniq -c | sed -r 's/(.*) (.*)/\2 \1/' | head -n "$2"
```
* Список всех ответов на запросы без 200 (все отлично) и - (я так понимаю те пакеты, которые остались без ответа) *
```
echo "список всех ошибок с момента последнего запуска"
cat $MyLogFile | cut -f 9 -d ' ' | grep -v 200 | grep -v "-" | sort | uniq
```
* Список всех ответов сервера, кроме тех запросов, которые остались без ответа *
```
echo "список всех кодов возврата + количество с момента последнего запуска"
cat $MyLogFile | cut -f 9 -d ' ' | grep -v "-" | sort | uniq -c | sed -r 's/(.*) (.*)/\2 \1/'
```
* Выгружаю всё во временный файл *
```
} >> $MailFileText
```
* Отправляю письмо *
```
cat $MailFileText | mail -s "log" root@localhost
```
* Удаляю временные файлы *
```
rm $MailFileText
```
* Удаляю лок файл *
```
trap 'rm $LOCKFILE' EXIT
```
